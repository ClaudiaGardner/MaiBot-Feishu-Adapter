# 长连接模式说明

## 为什么使用长连接模式？

如果你的服务器满足以下任一情况，建议使用长连接模式：

1. **在内网环境**，无公网 IP
2. **防火墙限制**，只开放了少量端口
3. **不想暴露服务**，不希望对外开放 HTTP 服务
4. **无法使用内网穿透**工具（如 frp、ngrok）

## 长连接 vs Webhook 对比

| 特性 | 长连接模式 | Webhook 模式 |
|-----|----------|------------|
| **网络要求** | 只需出站连接 | 需要入站连接（公网IP） |
| **端口开放** | ❌ 无需开放端口 | ✅ 需要开放 HTTP 端口 |
| **配置复杂度** | ⭐⭐ 简单 | ⭐⭐⭐⭐ 复杂（需配置域名/穿透） |
| **稳定性** | ⭐⭐⭐⭐⭐ 高（自动重连） | ⭐⭐⭐ 中等 |
| **延迟** | ⭐⭐⭐⭐⭐ 低（实时推送） | ⭐⭐⭐⭐ 低 |
| **安全性** | ⭐⭐⭐⭐⭐ 高（主动连接） | ⭐⭐⭐ 需配置签名验证 |

## 架构原理

### 长连接模式

```
适配器 (内网)
    ↓ 主动连接 (WebSocket Client)
飞书长连接服务器 (公网)
    ↓ 推送事件
适配器处理
```

**流程**:
1. 适配器获取长连接 Endpoint（通过 API）
2. 适配器主动连接飞书 WebSocket 服务器
3. 飞书推送事件到已连接的客户端
4. 适配器处理事件并回复

### Webhook 模式（旧版）

```
飞书服务器 (公网)
    ↓ HTTP POST 请求
适配器 HTTP 服务器 (需要公网访问)
```

**要求**:
1. 适配器需要公网 IP 或域名
2. 需要开放 HTTP 端口（如 9000）
3. 或使用内网穿透工具

## 技术实现

### 核心组件

1. **event_client.py** - 飞书长连接客户端
   - 获取 Endpoint
   - 建立 WebSocket 连接
   - 心跳保活（每 30 秒）
   - 自动重连（指数退避）
   - 事件处理

2. **main.py** - 主程序
   - 同时运行两个异步任务：
     - MaiBot WebSocket 客户端
     - 飞书长连接客户端
   - 优雅关闭处理

### 心跳机制

```python
# 每 30 秒发送一次心跳
{"type": "PING"}

# 飞书回复
{"type": "PONG"}
```

### 重连机制

- 使用指数退避策略
- 初始等待：2 秒
- 最大等待：60 秒
- 最大重试：5 次
- 每次连接失败后重新获取 Endpoint

## 配置步骤

### 1. 飞书开放平台配置

1. 登录 [飞书开放平台](https://open.feishu.cn/)
2. 进入应用 → **事件订阅**
3. 选择 **"使用长连接接收事件"**（重要！）
4. 订阅事件：`im.message.receive_v1`
5. 无需配置回调地址
6. 无需 Verification Token

### 2. 修改 config.toml

```toml
[feishu]
app_id = "cli_xxxxx"
app_secret = "your_secret"

# 不需要以下配置：
# verification_token  ❌
# encrypt_key        ❌
# [adapter] 配置段   ❌
```

### 3. 启动适配器

```bash
cd /home/cloud/maimai/MaiBot-Feishu-Adapter
conda activate MaiBotEnv
python main.py
```

看到以下日志说明成功：

```
✅ 获取长连接 Endpoint 成功
🔗 正在连接飞书长连接服务...
✅ 飞书长连接已建立
💓 发送心跳包
💚 收到心跳响应
```

## 常见问题

### Q1: 连接失败怎么办？

**检查清单**:
- ✅ App ID 和 App Secret 是否正确
- ✅ 应用是否已发布
- ✅ 网络能否访问 `open.feishu.cn`
- ✅ 防火墙是否允许出站 WebSocket 连接

### Q2: 连接断开怎么办？

适配器会**自动重连**，无需人工干预。查看日志：

```
⚠️ 连接已关闭
🔄 2 秒后重连... (尝试 1/5)
```

### Q3: 如何验证连接状态？

查看日志中的心跳包：

```bash
screen -r feishu-adapter

# 应该看到每 30 秒一次的心跳
💓 发送心跳包
💚 收到心跳响应
```

### Q4: 能否改回 Webhook 模式？

可以，但需要修改代码：

1. 保留原来的 `webhook_handler.py`
2. 在 `main.py` 中启动 Flask 服务器
3. 配置公网地址或内网穿透
4. 在飞书平台改为"将事件发送至开发者服务器"

不推荐，除非你有稳定的公网环境。

## 性能和限制

### 性能指标

- **消息延迟**: < 100ms（网络条件良好时）
- **心跳间隔**: 30 秒
- **重连延迟**: 2-60 秒（指数退避）
- **并发处理**: 支持异步并发

### 官方限制

- **连接数**: 每个应用最多 10 个并发连接
- **消息频率**: 受飞书 API QPS 限制
- **连接时长**: 无限制（只要保持心跳）

## 监控建议

1. **日志监控**
   - 关注"连接已关闭"警告
   - 关注重连次数
   - 关注心跳超时

2. **告警设置**
   - 连续 5 次重连失败 → 发送告警
   - 长时间无心跳响应 → 发送告警

3. **健康检查**
   ```bash
   # 检查进程是否运行
   screen -ls | grep feishu-adapter
   
   # 查看最新日志
   screen -r feishu-adapter
   ```

## 迁移指南

如果你已经使用 Webhook 模式，迁移到长连接模式：

### 步骤 1: 备份现有配置

```bash
cp config.toml config.toml.backup
```

### 步骤 2: 更新代码

```bash
cd /home/cloud/maimai/MaiBot-Feishu-Adapter
git pull  # 或手动更新文件
```

### 步骤 3: 修改配置

删除 `config.toml` 中的：
- `verification_token`
- `encrypt_key`
- `[adapter]` 配置段

### 步骤 4: 修改飞书配置

在飞书开放平台：
- 事件订阅 → 改为"使用长连接接收事件"
- 删除回调地址配置

### 步骤 5: 重启适配器

```bash
screen -S feishu-adapter -X quit
./start_all.sh start  # 或单独启动
```

## 总结

长连接模式特别适合：
- ✅ 内网环境
- ✅ 端口受限
- ✅ 追求稳定性
- ✅ 快速部署

建议使用长连接模式，除非你有特殊需求必须使用 Webhook。
